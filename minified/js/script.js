window.addEventListener("DOMContentLoaded",e=>{"use strict";let t,r,s=window.indexedDB.open("1000HoursApp",1),i=new class{constructor(){this.skills={div:document.querySelector(".skills"),list:document.querySelector(".skills__list"),addEl:document.querySelector(".add-skill-element")},this.add={div:document.querySelector(".add-skill"),input:document.querySelector(".add-skill__input")},this.edit={div:document.querySelector(".edit-skill"),input:document.querySelector(".edit-skill__input")}}getSkills(){s.onsuccess=(e=>{let t=(r=s.result).transaction(["skills"],"readwrite").objectStore("skills");this.updateSkills(t,this.drawSkills)})}drawSkills(){let e=Object.keys(i.copy),t=new DocumentFragment;for(let r=0,s=e.length;s>r;r++){let s=e[r];i.createSkillsLi(i.copy[s].name,s,t)}i.skills.list.appendChild(t)}updateSkills(e,t){this.copy={},e.openCursor().onsuccess=(e=>{let r=e.target.result;r?(this.copy[r.primaryKey]=r.value,r.continue()):t&&t()})}showAddSkill(){n.textContent="ADD SKILL",this.add.input.value="",history.pushState({el:"addSkill"},"addSkill"),y(this.skills.div,this.add.div),m(this.add.input)}addSkillToDB(){let e=this.add.input.value,t={name:e,records:[],total:0},s=r.transaction(["skills"],"readwrite").objectStore("skills"),c=s.put(t);c.onsuccess=(t=>{this.updateSkills(s,function(){i.createSkillsLi(e,Object.keys(i.copy).slice(-1)[0])}),history.back()}),c.onerror=(e=>{p("Sorry we couldn't create the skill due to insufficient storage available. Try again after freeing up space.")})}createSkillsLi(e,t,r=this.skills.list){let s=document.createElement("li");s.classList.add("skills__element"),s.textContent=e,s.tabIndex="1",s.setAttribute("key",t),S(s,r,"skills__element-container")}showEditSkill(){n.textContent="EDIT SKILL",this.edit.input.value=this.currSkill.textContent,history.pushState({el:"editSkill"},"editSkill"),y(this.skills.div,this.edit.div),m(this.edit.input)}renameSkill(){let e=this.currSkillKey,t=this.edit.input.value,s=this.copy[e],i=r.transaction(["skills"],"readwrite").objectStore("skills");s.name=t;let c=i.put(s,e);c.onsuccess=(e=>{this.currSkill.textContent=t,history.back()}),c.onerror=(e=>{p("Sorry we couldn't rename the skill due to insufficient storage available. Try again after freeing up space.")})}removeSkill(){let e=this.currSkillKey,t=r.transaction(["skills"],"readwrite").objectStore("skills");delete this.copy[e],t.delete(e).onsuccess=(e=>{this.currSkill.parentElement.remove(),history.back()})}},c=new class{constructor(){this.records={div:document.querySelector(".records"),list:document.querySelector(".records__list"),addEl:document.querySelector(".add-record-element")},this.add={div:document.querySelector(".add-record"),inputs:{h:document.querySelector(".add-record__input-hours"),m:document.querySelector(".add-record__input-minutes")}},this.edit={div:document.querySelector(".edit-record"),inputs:{h:document.querySelector(".edit-record__input-hours"),m:document.querySelector(".edit-record__input-minutes")}},this.hInputs=[this.add.inputs.h,this.edit.inputs.h],this.mInputs=[this.add.inputs.m,this.edit.inputs.m],this.currText=[0,0],this.watchInputs()}showRecords(){n.textContent="RECORDS",this.recordsArray=i.copy[this.currSkillKey].records,history.pushState({el:"records"},"records"),y(i.skills.div,this.records.div),m(a.picker.w),this.drawRecords()}drawRecords(){!function(e,t){let r=e.querySelectorAll(t);for(let e=1,t=r.length;t>e;e++)r[e].parentElement.remove()}(this.records.list,".records__element");let e=new DocumentFragment,t=b(),r=this.recordsArray.slice(-5).filter(e=>t===e.date);for(let t=0,s=r.length;s>t;t++){let{date:s,h:i,m:c}=r[t];this.createRecordsLi(`${i}h ${c}m`,e)}this.records.list.appendChild(e),this.drawWeek()}showAddRecord(){n.textContent="ADD RECORD",this.currObj=i.copy[this.currSkillKey],this.add.inputs.h.value="",this.add.inputs.m.value="",history.pushState({el:"addRecord"},"addRecord"),y(this.records.div,this.add.div),m(this.add.inputs.h)}addRecordToDB(){let e=r.transaction(["skills"],"readwrite").objectStore("skills"),t=Number(this.add.inputs.h.value),s=Number(this.add.inputs.m.value);this.recordsArray.push({date:b(),h:t,m:s});let c=e.put(i.copy[this.currSkillKey],this.currSkillKey);c.onsuccess=(e=>{this.drawRecords(),history.back()}),c.onerror=(e=>{p("Sorry we couldn't add the record due to insufficient storage available. Try again after freeing up space.")})}createRecordsLi(e,t=this.records.list){let r=document.createElement("li");r.classList.add("records__element"),r.textContent=e,r.tabIndex="1",S(r,t,"records__element-container")}showEditRecord(){n.textContent="EDIT RECORD",this.currObj=i.copy[this.currSkillKey],this.edit.inputs.h.value=this.currText[0],this.edit.inputs.m.value=this.currText[1],history.pushState({el:"editRecord"},"editRecord"),y(this.records.div,this.edit.div),m(this.edit.inputs.h)}changeRecord(){let e=r.transaction(["skills"],"readwrite").objectStore("skills"),t=Number(this.edit.inputs.h.value),s=Number(this.edit.inputs.m.value),c=this.recordsArray.findIndex(e=>e.date===b()&&e.h===this.currText[0]&&e.m===this.currText[1]);this.recordsArray[c]={date:b(),h:t,m:s};let l=e.put(i.copy[this.currSkillKey],this.currSkillKey);l.onsuccess=(e=>{this.el.textContent=`${t}h ${s}m`,this.drawWeek(),history.back()}),l.onerror=(e=>{p("Sorry we couldn't change the record due to insufficient storage available. Try again after freeing up space.")})}removeRecord(){let e=r.transaction(["skills"],"readwrite").objectStore("skills"),t=this.recordsArray.findIndex(e=>e.date===b()&&e.h===this.currText[0]&&e.m===this.currText[1]);this.recordsArray.splice(t,1),e.put(i.copy[this.currSkillKey],this.currSkillKey).onsuccess=(e=>{this.drawRecords(),history.back()})}watchInputs(){for(let e=this.hInputs.length;e--;)this.hInputs[e].addEventListener("keyup",t=>{f(this.hInputs[e],23-a.timeToday.h+c.currText[0])});for(let e=this.mInputs.length;e--;)this.mInputs[e].addEventListener("keyup",t=>{f(this.mInputs[e],59-a.timeToday.m+c.currText[1])})}drawWeek(){let e=new Date,t=e.getDate(),r=e.toLocaleDateString("en",{weekday:"short"}),s=b(e.setDate(t-e.getDay())),i={Sun:{h:0,m:0},Mon:{h:0,m:0},Tue:{h:0,m:0},Wed:{h:0,m:0},Thu:{h:0,m:0},Fri:{h:0,m:0},Sat:{h:0,m:0}},c=this.recordsArray.findIndex(e=>e.date>=s),l=c>-1?this.recordsArray.slice(c):[];for(let e=l.length;e--;){let t=l[e],r=new Date(t.date).toLocaleDateString("en",{weekday:"short"});i[r].h+=t.h,i[r].m+=t.m}a.timeToday=i[r],a.vals=i,a.drawProportions()}drawMonth(){let e=new Date,t=e.getMonth(),r=e.getFullYear(),s=b(r,t,1),i=s,c=b(r,t+1,0),l={},n={},h=s-new Date(s).getDay()*o+6*o;for(;i<=c;){c<h&&(h=c);let e=new Date(i).toLocaleDateString("en",d)+"-"+new Date(h).toLocaleDateString("en",d);l[h]={},n[e]={h:0,m:0},i=h+o,h+=7*o}let u=[...this.recordsArray],k=Object.keys(l),_=Object.keys(n),m=u.findIndex(e=>e.date>=s),p=m>-1?this.recordsArray.slice(m):[];for(let e=p.length;e--;){let t=p[e],r=_[k.findIndex(e=>e>=t.date)];n[r].h+=t.h,n[r].m+=t.m}a.vals=n,a.drawProportions()}drawYear(){let e=b((new Date).getFullYear(),0,1),t={Jan:{h:0,m:0},Feb:{h:0,m:0},Mar:{h:0,m:0},Apr:{h:0,m:0},May:{h:0,m:0},Jun:{h:0,m:0},Jul:{h:0,m:0},Aug:{h:0,m:0},Sep:{h:0,m:0},Oct:{h:0,m:0},Nov:{h:0,m:0},Dec:{h:0,m:0}},r=this.recordsArray.findIndex(t=>t.date>=e),s=r>-1?this.recordsArray.slice(r):[];for(let e=s.length;e--;){let r=s[e],i=new Date(r.date).toLocaleDateString("en",{month:"short"});t[i].h+=r.h,t[i].m+=r.m}a.vals=t,a.drawProportions()}drawAllTime(){let e={allTime:{h:0,m:0}};for(let t=this.recordsArray.length;t--;){let r=this.recordsArray[t];e.allTime.h+=r.h,e.allTime.m+=r.m}a.vals=e,a.drawProportions()}},l=new class{constructor(){this.leftSoftkey=document.querySelector(".softkey__left"),this.centerSoftkey=document.querySelector(".softkey__center"),this.rightSoftkey=document.querySelector(".softkey__right")}setSoftkeys(e){switch(e){case"add-skill-element skills__element":this.changeSoftkeys("Info","SELECT","");break;case"skills__element":this.changeSoftkeys("Info","SELECT","Edit");break;case"add-skill__input":case"edit-skill__input":case"add-record__input-hours":case"add-record__input-minutes":case"edit-record__input-hours":case"edit-record__input-minutes":this.changeSoftkeys("Cancel","","");break;case"add-skill__button add-skill__button-add":case"add-skill__button add-skill__button-cancel":case"edit-skill__button edit-skill__button-save":case"edit-skill__button edit-skill__button-remove":case"edit-skill__button edit-skill__button-cancel":case"add-record add-record__button-add":case"add-record add-record__button-edit":case"edit-record__button edit-record__button-save":case"edit-record__button edit-record__button-remove":case"edit-record__button edit-record__button-cancel":case"records__chart-pick records__chart-pick-week":case"records__chart-pick records__chart-pick-month":case"records__chart-pick records__chart-pick-year":case"records__chart-pick records__chart-pick-all-time":case"add-record-element records__element":this.changeSoftkeys("","SELECT","");break;case"records__chart":case"records__legend":case"info__text":this.changeSoftkeys("","","");break;case"records__element":this.changeSoftkeys("","","Edit")}}left(e){switch(e){case"add-skill__input":case"edit-skill__input":case"add-record__input-hours":case"add-record__input-minutes":case"edit-record__input-hours":case"edit-record__input-minutes":history.back();break;case"add-skill-element skills__element":case"skills__element":n.textContent="INFO",history.pushState({el:"info"},"info"),y(i.skills.div,u),m(u.firstElementChild.firstElementChild)}}changeSoftkeys(e,t,r){this.leftSoftkey.textContent=e,this.centerSoftkey.textContent=t,this.rightSoftkey.textContent=r}center(e,t){switch(e){case"add-skill-element skills__element":i.showAddSkill();break;case"add-skill__button add-skill__button-add":r?i.addSkillToDB():p("Sorry, we couldn't access the database.");break;case"add-skill__button add-skill__button-cancel":case"edit-skill__button edit-skill__button-cancel":case"add-record__button add-record__button-cancel":case"edit-record__button edit-record__button-cancel":history.back();break;case"edit-skill__button edit-skill__button-save":r?i.renameSkill():p("Sorry, we couldn't access the database.");break;case"edit-skill__button edit-skill__button-remove":r?i.removeSkill():p("Sorry, we couldn't access the database.");break;case"skills__element":c.currSkillKey=Number(t.getAttribute("key")),r?c.showRecords():p("Sorry, we couldn't access the database.");break;case"add-record-element records__element":c.showAddRecord();break;case"add-record__button add-record__button-add":c.addRecordToDB();break;case"edit-record__button edit-record__button-save":c.changeRecord();break;case"edit-record__button edit-record__button-remove":c.removeRecord();break;case"records__chart-pick records__chart-pick-week":c.drawWeek();break;case"records__chart-pick records__chart-pick-month":c.drawMonth();break;case"records__chart-pick records__chart-pick-year":c.drawYear();break;case"records__chart-pick records__chart-pick-all-time":c.drawAllTime()}}right(e,t){switch(e){case"skills__element":i.currSkillKey=Number(t.getAttribute("key")),i.currSkill=t,i.showEditSkill();break;case"records__element":c.el=t,c.currText=t.textContent.slice(0,-1).split("h ").map(e=>Number(e)),c.showEditRecord()}}},a=new class{constructor(){this.picker={div:c.records.list.querySelector(".records__chart-picker"),get w(){return this.div.querySelector(".records__chart-pick.records__chart-pick-week")},get m(){return this.div.querySelector(".records__chart-pick.records__chart-pick-month")},get y(){return this.div.querySelector(".records__chart-pick.records__chart-pick-year")},get a(){return this.div.querySelector(".records__chart-pick.records__chart-pick-all-time")}},this.c1={el:c.records.list.querySelector(".records__chart"),get ctx(){return this.el.getContext("2d")},w:window.innerWidth,get h(){return this.el.height}},this.c2={el:c.records.list.querySelector(".records__legend"),get ctx(){return this.el.getContext("2d")},w:this.c1.w,maxH:window.innerHeight-58},this.c2.el.width=this.c1.el.width=this.c2.w,this.colors=["#488f31","#3d9c73","#63b179","#88c580","#aed987","#d6ec91","#ffff9d","#fee17e","#fcc267","#f7a258","#ef8250","#ee7c4f","#e4604e"]}drawBlackCircle(){this.c1.ctx.strokeStyle="#fff",this.c1.ctx.beginPath(),this.c1.ctx.arc(this.c1.w/2,70,60,0,2*Math.PI),this.c1.ctx.closePath(),this.c1.ctx.stroke()}drawProportions(){let e=Object.keys(this.vals),t=0,r=0,s=0;for(let s=e.length;s--;){let i=e[s];t+=this.vals[i].m,r+=this.vals[i].h}let i=t%60,c=r+Math.floor(t/60),l=c+i/60,a=`Total Time: ${c}h, ${i}m`;if(this.c1.ctx.clearRect(0,0,this.c1.w,this.c1.h),this.c1.ctx.lineWidth=10,l>0)for(let t=e.length;t--;){let r=e[t],i=this.vals[r],c=i.m%60,a=i.h+Math.floor(i.m/60)+c/60,d=s+2*Math.PI*a/l;this.c1.ctx.strokeStyle=this.colors[t],this.c1.ctx.beginPath(),this.c1.ctx.arc(this.c1.w/2,70,60,s,d),this.c1.ctx.stroke(),s=d}else this.drawBlackCircle();this.c1.ctx.fillStyle="#fff",this.c1.ctx.fillText(a,this.c1.w/2-this.c1.ctx.measureText(a).width/2,76),this.drawLegend()}drawLegend(){let e=Object.keys(this.vals),t=e.length,r=this.c2.maxH;this.c2.ctx.clearRect(0,0,this.c2.w,this.c2.h),this.c2.el.height=t>8&&r<200?156:18*t+12,this.c2.ctx.font="12px Arial";for(let s=t;s--;){let t=e[s],i=10,c=18*s+8,l=this.vals[t],a=(this.vals[t],l.m%60),d=l.h+Math.floor(a/60);c+15>r&&r<200&&(i=140,c-=144),this.c2.ctx.fillStyle=this.colors[s],this.c2.ctx.fillRect(i,c,15,15),this.c2.ctx.fillStyle="#fff",this.c2.ctx.fillText(`${t}: ${d}h, ${a}m`,i+20,c+12)}}},d={year:"numeric",month:"numeric",day:"numeric"},o=864e5,n=document.querySelector(".header__text"),h=document.querySelector(".error"),u=document.querySelector(".info");function k(e,t){let r;switch(e){case 1:r=t.nextElementSibling||t.parentElement.firstElementChild;break;case-1:r=t.previousElementSibling||t.parentElement.lastElementChild}t!==r&&m(r)}function _(e,t){let r;switch(e){case 1:r=t.nextElementSibling||t.parentElement.firstElementChild;break;case-1:r=t.previousElementSibling||t.parentElement.lastElementChild}t!==r&&m(r.firstElementChild)}function m(e){let t=document.activeElement,r=e.parentElement;if(t.id="",r.focus(),e.focus(),e.id="focused",l.setSoftkeys(e.className),r.parentElement.scrollTop+=r.getBoundingClientRect().y-28,"INPUT"===e.tagName){let t=e.value;e.value="",e.value=t}}function p(e){e!==h.textContent&&(h.textContent=e),setTimeout(e=>{h.classList.contains("hidden")&&(h.classList.remove("hidden"),t=setTimeout(e=>h.classList.add("hidden"),3e3))},50)}function y(e,t){t.classList.add("visible"),t.classList.remove("hidden"),e.classList.add("hidden"),e.classList.remove("visible")}function S(e,t,r){let s=document.createElement("div");s.className=r,s.appendChild(e),s.setAttribute("tabIndex",1),t.appendChild(s)}function b(...e){return Date.parse(new Date(...e).toLocaleDateString("en",d))}function f(e,t){let r=Number(e.value);r>t?e.value=t:r<0&&(e.value=0)}s.onerror=(e=>{p("Sorry, we couldn't access the database.")}),s.onupgradeneeded=(e=>{s.result.createObjectStore("skills",{autoIncrement:!0})}),i.getSkills(),window.addEventListener("popstate",e=>{let t=document.querySelector(".visible");switch(t.className){case"add-skill visible":case"edit-skill visible":case"records visible":case"info visible":n.textContent="SKILLS",y(t,i.skills.div),m(i.skills.addEl);break;case"add-record visible":case"edit-record visible":n.textContent="RECORDS",c.currText[0]=0,c.currText[1]=0,y(t,c.records.div),m(c.records.addEl)}}),history.replaceState({el:"skills"},"skills"),document.addEventListener("keydown",function(e){let t=e.target;switch(console.log(t.getAttribute("type"),t),e.key){case"ArrowUp":e.preventDefault(),_(-1,t.parentElement);break;case"ArrowDown":e.preventDefault(),_(1,t.parentElement);break;case"ArrowLeft":e.preventDefault(),k(-1,t);break;case"ArrowRight":e.preventDefault(),k(1,t);break;case"a":case"SoftLeft":l.left(t.className);break;case"d":case"SoftRight":l.right(t.className,t);break;case"Enter":l.center(t.className,t);break;case"Backspace":i.skills.div.classList.contains("hidden")&&e.preventDefault(),"INPUT"!==t.tagName&&history.back()}}),m(i.skills.addEl)});